<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Renzz Marketplace - Stok Otomatis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .stok-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        .stok-ada { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .stok-habis { background: rgba(249, 115, 115, 0.2); color: #f97373; opacity: 0.6; }
        .product.disabled { pointer-events: none; filter: grayscale(1); opacity: 0.7; }
    </style>
</head>
<body>
<div class="app">
    <main class="layout">
        <section class="card">
            <div class="card-title">CATALOG <strong>ROBUX</strong></div>
            <div id="productGrid" class="product-grid">
                </div>
        </section>

        <section class="card checkout">
            <div class="card-title">PANEL <strong>PEMBAYARAN</strong></div>
            <div id="checkoutContent">
                <div class="checkout-empty">Pilih produk untuk melihat sisa stok.</div>
            </div>
            <button class="btn" id="payButton" disabled>Bayar via QRIS</button>
        </section>
    </main>
</div>

<script>
    const BACKEND_BASE_URL = "https://pikirkansecaralogika.vercel.app"; // GANTI DENGAN URL VERCEL ANDA

    // Data Produk dengan ID unik untuk sinkronisasi stok di database
    let products = [
        { id: "rbx_100", name: "100 ROBUX", price: 8800, emoji: "ðŸ’Ž", stock: 0 },
        { id: "rbx_200", name: "200 ROBUX", price: 18000, emoji: "ðŸ”¥", stock: 0 }
    ];

    async function fetchStock() {
        try {
            const res = await fetch(`${BACKEND_BASE_URL}/api/get-stock`);
            const stockData = await res.json();
            
            products = products.map(p => ({
                ...p,
                stock: stockData[p.id] || 0
            }));
            renderProducts();
        } catch (e) { console.error("Gagal mengambil stok", e); }
    }

    function renderProducts() {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        products.forEach(p => {
            const isAvailable = p.stock > 0;
            const el = document.createElement("div");
            el.className = `product ${!isAvailable ? 'disabled' : ''}`;
            el.innerHTML = `
                <div class="product-main">
                    <div class="product-thumb">${p.emoji}</div>
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div class="stok-badge ${isAvailable ? 'stok-ada' : 'stok-habis'}">
                            ${isAvailable ? `Stok: ${p.stock}` : 'Stok Habis'}
                        </div>
                        <div class="product-price">Rp ${p.price.toLocaleString()}</div>
                    </div>
                </div>
            `;
            if(isAvailable) el.onclick = () => selectProduct(p);
            grid.appendChild(el);
        });
    }

    // Fungsi handlePay() akan memanggil API /api/create-qris yang juga mengunci stok sementara
    async function handlePay() {
        // Logika polling dan QRIS sama seperti kode sebelumnya
    }

    window.onload = fetchStock;
</script>
</body>
</html>
