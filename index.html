<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Renzz Marketplace - Payment System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816; --bg-soft: #0f172a; --primary: #38bdf8;
      --text: #e5e7eb; --muted: #9ca3af; --danger: #f97373; --success: #4ade80;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: var(--bg-soft); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; position: relative; }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); }
    .card.selected { border-color: var(--primary); background: rgba(56, 189, 248, 0.1); }
    .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 3px 8px; border-radius: 5px; background: var(--primary); color: #000; font-weight: bold; }
    .stock-info { font-size: 12px; color: var(--muted); margin-top: 5px; }
    .btn { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .btn:disabled { background: #444; color: #888; }
    /* Modal Styles */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: #fff; color: #000; padding: 20px; border-radius: 15px; text-align: center; max-width: 90%; }
    #qrImage { width: 250px; height: 250px; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <h2>ðŸ›’ Renzz Marketplace</h2>
  <p style="color: var(--muted)">Pilih produk dan lakukan pembayaran otomatis.</p>

  <div id="productGrid" class="grid"></div>

  <div style="margin-top: 30px; background: var(--bg-soft); padding: 20px; border-radius: 12px;">
    <h4>Konfirmasi Pesanan</h4>
    <div id="orderPreview" style="margin: 15px 0; color: var(--muted)">Silakan pilih produk...</div>
    <input type="text" id="username" placeholder="Masukkan Username Roblox" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 10px;">
    <button id="payButton" class="btn" disabled>BAYAR SEKARANG</button>
  </div>
</div>

<div id="qrModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-bottom: 5px;">Scan QRIS Untuk Bayar</h3>
    <p id="timer" style="font-size: 12px; color: red;">Berlaku selama 5:00</p>
    <img id="qrImage" src="" alt="QRIS">
    <div style="margin-top: 15px;">
      <p style="font-size: 14px;">Total: <strong id="totalBayar"></strong></p>
      <button onclick="location.reload()" style="margin-top: 10px; cursor: pointer;">Batal / Tutup</button>
    </div>
  </div>
</div>

<script>
  // --- KONFIGURASI ---
  const BACKEND_URL = "https://pikirkansecaralogika.vercel.app"; 
  
  const products = [
    { id: "rbx_100", name: "100 ROBUX", price: 880, stock: 50, emoji: "ðŸ’Ž" },
    { id: "rbx_200", name: "200 ROBUX", price: 17500, stock: 25, emoji: "ðŸ”¥" },
    { id: "rbx_500", name: "500 ROBUX", price: 45000, stock: 0, emoji: "ðŸš€" }
  ];

  let selectedProduct = null;

  function renderProducts() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = products.map(p => `
      <div class="card ${p.stock <= 0 ? 'disabled' : ''}" onclick="selectProduct('${p.id}')" id="card-${p.id}">
        <div class="badge">${p.stock <= 0 ? 'HABIS' : 'PROMO'}</div>
        <div style="font-size: 30px;">${p.emoji}</div>
        <div style="font-weight: bold; margin-top: 10px;">${p.name}</div>
        <div class="stock-info">Stok: ${p.stock}</div>
        <div style="color: var(--primary); font-weight: bold; margin-top: 5px;">Rp ${p.price.toLocaleString()}</div>
      </div>
    `).join('');
  }

  function selectProduct(id) {
    selectedProduct = products.find(p => p.id === id);
    if (selectedProduct.stock <= 0) return;

    // UI Update
    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`card-${id}`).classList.add('selected');
    document.getElementById('orderPreview').innerHTML = `Produk: <strong>${selectedProduct.name}</strong><br>Total: <strong>Rp ${selectedProduct.price.toLocaleString()}</strong>`;
    document.getElementById('payButton').disabled = false;
  }

  async function handlePay() {
    const username = document.getElementById('username').value;
    if (!username) return alert("Masukkan username dulu!");

    const payBtn = document.getElementById('payButton');
    payBtn.disabled = true;
    payBtn.innerText = "MENGAMBIL QRIS...";

    const orderId = "INV-" + Date.now();

    try {
      const response = await fetch(`${BACKEND_URL}/api/create-qris`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: selectedProduct.price,
          order_id: orderId,
          product_id: selectedProduct.id
        })
      });

      const result = await response.json();

      if (result.success || result.data) {
        // Tampilkan Modal QRIS
        const qrData = result.data?.qr_link || result.qr_link;
        document.getElementById('qrImage').src = qrData;
        document.getElementById('totalBayar').innerText = "Rp " + selectedProduct.price.toLocaleString();
        document.getElementById('qrModal').style.display = 'flex';
        
        // Mulai cek status (Polling)
        startPolling(orderId);
      } else {
        alert("Gagal: " + (result.error || "Terjadi kesalahan server"));
      }
    } catch (err) {
      alert("Error menghubungi server!");
    } finally {
      payBtn.innerText = "BAYAR SEKARANG";
      payBtn.disabled = false;
    }
  }

  function startPolling(orderId) {
    const interval = setInterval(async () => {
      try {
        const res = await fetch(`https://app.pakasir.com/api/transaction/check?order_id=${orderId}`);
        const status = await res.json();
        
        if (status.data?.status === "success") {
          clearInterval(interval);
          alert("PEMBAYARAN BERHASIL! Produk akan segera dikirim.");
          location.reload();
        }
      } catch (e) { console.log("Cek status..."); }
    }, 5000); // Cek setiap 5 detik
  }

  document.getElementById('payButton').onclick = handlePay;
  renderProducts();
</script>
</body>
</html>

