<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Renzz Marketplace - Payment System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* CSS Styling untuk tampilan premium */
    :root {
      --bg: #050816; --bg-soft: #0f172a; --primary: #38bdf8;
      --text: #e5e7eb; --muted: #9ca3af; --danger: #f97373; --success: #4ade80;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: var(--bg-soft); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; position: relative; }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); }
    .card.selected { border-color: var(--primary); background: rgba(56, 189, 248, 0.1); }
    .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 3px 8px; border-radius: 5px; background: var(--primary); color: #000; font-weight: bold; }
    .stock-badge { font-size: 11px; margin-top: 5px; color: var(--success); }
    .stock-out { color: var(--danger); }
    .btn { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .btn:disabled { background: #444; color: #888; cursor: not-allowed; }
    /* Modal QRIS */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal { background: #fff; color: #000; padding: 20px; border-radius: 15px; text-align: center; max-width: 400px; width: 100%; }
    #qrImage { width: 100%; max-width: 250px; border: 1px solid #ddd; border-radius: 10px; }
  </style>
</head>
<body>

<div class="container">
  <h2>ðŸ›’ Renzz Marketplace</h2>
  <p style="color: var(--muted)">Pilih produk. Proses otomatis & stok terupdate.</p>

  <div id="productGrid" class="grid"></div>

  <div style="margin-top: 30px; background: var(--bg-soft); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
    <h4 style="margin-top:0">Konfirmasi Pesanan</h4>
    <div id="orderPreview" style="margin-bottom: 15px; color: var(--muted)">Pilih produk di atas...</div>
    <input type="text" id="username" placeholder="Masukkan Username Roblox" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 15px; box-sizing: border-box;">
    <button id="payButton" class="btn" disabled>BAYAR SEKARANG</button>
  </div>
</div>

<div id="qrModal" class="overlay">
  <div class="modal">
    <h3>Scan QRIS Untuk Bayar</h3>
    <img id="qrImage" src="" alt="QRIS">
    <p style="font-size: 14px; margin-top: 15px;">Total: <strong id="totalBayar"></strong></p>
    <p style="font-size: 12px; color: #666;">Order ID: <span id="displayOrderId"></span></p>
    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 20px; cursor: pointer;">Tutup</button>
  </div>
</div>

<script>
  // 1. GANTI INI DENGAN URL VERCEL KAMU!
  const BACKEND_URL = "https://kepodeh.vercel.app"; 
  
  const products = [
    { id: "reseller-panel", name: "100 ROBUX", price: 1200, stock: 50, emoji: "ðŸ’Ž" },
    { id: "tangan-kanan-panel", name: "200 ROBUX", price: 2500, stock: 25, emoji: "ðŸ”¥" }
  ];

  let selectedProduct = null;

  function renderProducts() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = products.map(p => `
      <div class="card ${p.stock <= 0 ? 'disabled' : ''}" onclick="selectProduct('${p.id}')" id="card-${p.id}">
        <div class="badge">${p.stock <= 0 ? 'HABIS' : 'PROMO'}</div>
        <div style="font-size: 32px;">${p.emoji}</div>
        <div style="font-weight: bold; margin-top: 10px; font-size: 18px;">${p.name}</div>
        <div class="stock-badge ${p.stock <= 0 ? 'stock-out' : ''}">
           Stok: ${p.stock <= 0 ? 'Habis' : p.stock}
        </div>
        <div style="color: var(--primary); font-weight: bold; margin-top: 8px;">Rp ${p.price.toLocaleString()}</div>
      </div>
    `).join('');
  }

  function selectProduct(id) {
    selectedProduct = products.find(p => p.id === id);
    if (!selectedProduct || selectedProduct.stock <= 0) return;

    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`card-${id}`).classList.add('selected');
    
    document.getElementById('orderPreview').innerHTML = `
      Produk: <strong>${selectedProduct.name}</strong><br>
      Total: <strong>Rp ${selectedProduct.price.toLocaleString()}</strong>
    `;
    document.getElementById('payButton').disabled = false;
  }

  async function handlePay() {
    const username = document.getElementById('username').value.trim();
    if (!username) return alert("Masukkan username Roblox!");

    const payBtn = document.getElementById('payButton');
    payBtn.disabled = true;
    payBtn.innerText = "MENGAMBIL QRIS...";

    const orderId = "INV-" + Date.now();

    try {
      const response = await fetch(`${BACKEND_URL}/api/create-qris`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: selectedProduct.price,
          order_id: orderId,
          product_id: selectedProduct.id
        })
      });

      const result = await response.json();

      if (response.ok) {
        // Tampilkan QRIS
        const qrData = result.data?.qr_link || result.qr_link || `https://app.pakasir.com/qris/${result.data?.code}.png`;
        document.getElementById('qrImage').src = qrData;
        document.getElementById('totalBayar').innerText = "Rp " + selectedProduct.price.toLocaleString();
        document.getElementById('displayOrderId').innerText = orderId;
        document.getElementById('qrModal').style.display = 'flex';
      } else {
        alert("Gagal: " + (result.error || "Kesalahan Server"));
      }
    } catch (err) {
      alert("Koneksi ke backend gagal!");
    } finally {
      payBtn.innerText = "BAYAR SEKARANG";
      payBtn.disabled = false;
    }
  }

  document.getElementById('payButton').onclick = handlePay;
  renderProducts();
</script>
</body>
</html>
